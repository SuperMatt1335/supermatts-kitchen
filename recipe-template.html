<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recipe | SuperMatt's Kitchen</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="js/navbar.js"></script>
  <script src="components/footer.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- üñ® PRINT STYLES -->
  <style>
    @media print {
      custom-navbar, custom-footer, #print-recipe {
        display: none !important;
      }

      body {
        background: white;
        color: black;
      }

      main {
        padding: 0;
        margin: 0;
      }

      #recipe-container {
        max-width: 100%;
        box-shadow: none;
      }

      img {
        max-height: 400px;
        object-fit: cover;
      }

      a {
        text-decoration: none;
        color: black;
      }
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-800">
  <custom-navbar></custom-navbar>

  <main class="container mx-auto px-4 py-12">
    <div id="recipe-container" class="max-w-4xl mx-auto">
      <p class="text-center text-gray-500">Loading recipe...</p>
    </div>
  </main>

  <custom-footer></custom-footer>

  <script type="module">
    import { supabase } from './js/supabaseClient.js';

    const params = new URLSearchParams(window.location.search);
    const recipeId = params.get('id');

    async function loadRecipe() {
      const container = document.getElementById("recipe-container");

      try {
        // Fetch recipe
        const { data: recipe, error } = await supabase
          .from('recipes')
          .select('*')
          .eq('id', recipeId)
          .maybeSingle({ head: false, count: 'none' });

        if (error || !recipe) {
          container.innerHTML = `<p class="text-center text-gray-600">Recipe not found.</p>`;
          return;
        }

        // Check if admin is logged in
        const { data: { user } } = await supabase.auth.getUser();
        const isAdmin = user && user.email.toLowerCase() === 'matthew@remley.com';

        // ‚öôÔ∏è Store base ingredients for dynamic adjustment
        const baseServings = recipe.servings;
        const baseIngredients = recipe.ingredients;

        // Build recipe HTML
        container.innerHTML = `
          <div class="flex items-center justify-between mb-8">
            <a href="recipes.html" class="flex items-center text-indigo-600 hover:text-indigo-800">
              <i data-feather="arrow-left" class="mr-2"></i> Back to Recipes
            </a>
            ${
              isAdmin
                ? `<a href="edit-recipe.html?id=${recipeId}" class="flex items-center text-sm bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-200 transition">
                    <i data-feather="edit-2" class="mr-1 w-4 h-4"></i> Edit
                  </a>`
                : ''
            }
          </div>

          <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <img src="${recipe.image ? recipe.image + '?t=' + Date.now() : 'https://placehold.co/1200x630?text=No+Image'}" alt="${recipe.title}" class="w-full h-96 object-cover">
            <div class="p-6">
              <h1 class="text-3xl font-bold mb-2">${recipe.title}</h1>

              <!-- üñ® Print Button -->
              <div class="flex justify-end mb-6">
                <button
                  id="print-recipe"
                  class="flex items-center bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium px-3 py-1.5 rounded-md transition"
                >
                  <i data-feather="printer" class="w-4 h-4 mr-1"></i> Print Recipe
                </button>
              </div>

              <div class="flex flex-wrap gap-4 mb-4">
                <div class="flex items-center text-sm">
                  <i data-feather="clock" class="mr-1 text-indigo-600 w-4 h-4"></i>
                  <span>${recipe.time || ''}</span>
                </div>
                <div class="flex items-center text-sm">
                  <i data-feather="users" class="mr-1 text-indigo-600 w-4 h-4"></i>
                  <span id="servings">${recipe.servings || ''} servings</span>
                </div>
                <div class="flex items-center text-sm bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">
                  <i data-feather="star" class="mr-1 text-indigo-600 w-4 h-4"></i>
                  <span>${recipe.difficulty || '‚Äî'}</span>
                </div>
              </div>

              <p class="text-gray-600 mb-6">${recipe.description || ''}</p>

              <div class="mb-6">
                <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
                  Ingredients
                  <div class="flex items-center">
                    <span class="text-sm mr-2">Servings:</span>
                    <input type="number" id="serving-size" min="1" value="${recipe.servings || 1}" class="border rounded px-2 py-1 text-sm w-16">
                  </div>
                </h2>
                <ul class="space-y-2" id="ingredients-list">
                  ${
                    Array.isArray(recipe.ingredients)
                      ? recipe.ingredients.map(i => `
                        <li class="flex items-start">
                          <i data-feather="check-circle" class="mr-2 text-indigo-600 mt-1 w-4 h-4"></i>
                          <span class="ingredient-qty mr-1" data-qty="${i.quantity}">${i.quantity}</span>
                          <span class="ingredient-unit mr-1">${i.unit}</span>
                          <span class="ingredient-name">${i.name}</span>
                        </li>
                      `).join('')
                      : `<li>${recipe.ingredients || 'No ingredients listed.'}</li>`
                  }
                </ul>
              </div>

              <h2 class="text-xl font-bold mb-4">Instructions</h2>
              <ol class="space-y-4">
                ${
                  Array.isArray(recipe.instructions)
                    ? recipe.instructions.map((s, i) => `
                      <li class="flex">
                        <span class="font-bold mr-2">${i + 1}.</span>
                        <p>${s}</p>
                      </li>
                    `).join('')
                    : `<li>${recipe.instructions || 'No instructions provided.'}</li>`
                }
              </ol>

              ${
                recipe.notes
                  ? `
              <div class="mt-8 bg-indigo-50 p-6 rounded-xl">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                  <i data-feather="edit-3" class="mr-2 text-indigo-600"></i>
                  Chef's Notes
                </h2>
                ${
                  Array.isArray(recipe.notes)
                    ? `<ul class="list-disc pl-6 space-y-2">${recipe.notes.map(n => `<li>${n}</li>`).join('')}</ul>`
                    : `<p class="text-gray-700">${recipe.notes}</p>`
                }
              </div>`
                  : ''
              }
            </div>
          </div>
        `;

        feather.replace();

        // ‚öôÔ∏è Serving size adjustment logic
        const servingInput = document.getElementById("serving-size");
        const ingredientsList = document.getElementById("ingredients-list");
        const servingsText = document.getElementById("servings");

        servingInput.addEventListener("input", () => {
          const newServings = parseFloat(servingInput.value);
          if (!newServings || newServings <= 0) return;

          servingsText.textContent = `${newServings} servings`;

          // Scale ingredient quantities proportionally
          const scaledIngredients = baseIngredients.map(i => ({
            ...i,
            quantity: (i.quantity * newServings / baseServings)
          }));

          ingredientsList.innerHTML = scaledIngredients.map(i => `
            <li class="flex items-start">
              <i data-feather="check-circle" class="mr-2 text-indigo-600 mt-1 w-4 h-4"></i>
              <span>${i.quantity % 1 === 0 ? i.quantity : i.quantity.toFixed(2)}</span> ${i.unit} ${i.name}
            </li>
          `).join('');

          feather.replace();
        });

      } catch (error) {
        container.innerHTML = `<p class="text-center text-red-500">Error loading recipe: ${error.message}</p>`;
      }
    }

    loadRecipe();

    // üñ® Print handler
    document.addEventListener("click", (e) => {
      if (e.target.closest("#print-recipe")) {
        window.print();
      }
    });
  </script>

  <script>feather.replace();</script>
</body>
</html>